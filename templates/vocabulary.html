{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="vocabularyTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="my-vocab-tab" data-bs-toggle="tab" data-bs-target="#my-vocab" type="button" role="tab">
                Từ vựng của tôi
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="topics-tab" data-bs-toggle="tab" data-bs-target="#topics" type="button" role="tab">
                Học theo chủ đề
            </button>
        </li>
    </ul>

    <div class="tab-content" id="vocabularyTabContent">
        <!-- My Vocabulary Tab -->
        <div class="tab-pane fade show active" id="my-vocab" role="tabpanel">
            {% if user.is_authenticated %}
            <div class="mb-4">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWordModal">
                    <i class="fas fa-plus"></i> Thêm từ mới
                </button>
            </div>
            <div class="row row-cols-1 row-cols-md-3 g-4" id="myWordsGrid">
                <!-- Bạn sẽ fetch Supabase user_words và render tại đây bằng JS -->
            </div>
            {% else %}
            <div class="alert alert-warning">
                <h4 class="alert-heading">Yêu cầu đăng nhập!</h4>
                <p>Vui lòng đăng nhập hoặc đăng ký để sử dụng chức năng này.</p>
                <hr>
                <p class="mb-0">
                    <a href="{% url 'login' %}" class="btn btn-primary me-2">Đăng nhập</a>
                    <a href="{% url 'register' %}" class="btn btn-outline-primary">Đăng ký</a>
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Topics Tab -->
        <div class="tab-pane fade" id="topics" role="tabpanel">
            <div id="supabaseTopicsGrid" class="row row-cols-1 row-cols-md-2 g-4">
                <!-- Topic cards will be inserted here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const SUPABASE_URL = "{{ SUPABASE_URL }}";
    const SUPABASE_API_KEY = "{{ SUPABASE_API_KEY }}";

    const container = document.getElementById('supabaseTopicsGrid');
    container.innerHTML = '';

    // 🔁 Lấy danh sách chủ đề duy nhất từ Supabase
    fetch(`${SUPABASE_URL}/rest/v1/learning_topic`, {
        headers: {
            apikey: SUPABASE_API_KEY,
            Authorization: `Bearer ${SUPABASE_API_KEY}`
        }
    })
    .then(res => res.json())
    .then(topics => {
        if (topics.length === 0) {
            container.innerHTML = `<div class="alert alert-warning">Không có chủ đề nào.</div>`;
            return;
        }

        console.log(topics);

        topics?.forEach(row => {
            const topic = row.topic;

            const col = document.createElement('div');
            col.className = 'col';

            const card = document.createElement('div');
            card.className = 'card shadow-sm h-100';

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            const topicTitle = document.createElement('h5');
            topicTitle.className = 'card-title text-primary fw-bold';
            topicTitle.textContent = topic;

            const viewBtn = document.createElement('button');
            viewBtn.className = 'btn btn-outline-primary btn-sm mt-2';
            viewBtn.textContent = 'Xem từ vựng';
            viewBtn.onclick = () => loadWordsFromSupabase(topic, cardBody);

            cardBody.appendChild(topicTitle);
            cardBody.appendChild(viewBtn);
            card.appendChild(cardBody);
            col.appendChild(card);
            container.appendChild(col);
        });
    })
    .catch(err => {
        console.error("❌ Lỗi lấy chủ đề:", err);
        container.innerHTML = `<div class="alert alert-danger">Không thể tải chủ đề từ Supabase.</div>`;
    });

    // 🔍 Lấy từ vựng theo chủ đề
    function loadWordsFromSupabase(topic, container) {
        const url = `${SUPABASE_URL}/rest/v1/learning_topic?select=english,ipa,type,vietnamese&topic=eq.${encodeURIComponent(topic)}`;
        
        fetch(url, {
            headers: {
                apikey: SUPABASE_API_KEY,
                Authorization: `Bearer ${SUPABASE_API_KEY}`
            }
        })
        .then(res => res.json())
        .then(data => {
            const wordList = document.createElement('div');
            wordList.className = 'mt-3';

            if (data.length === 0) {
                wordList.innerHTML = `<div class="alert alert-secondary">Không có từ nào trong chủ đề này.</div>`;
            }

            data.forEach(word => {
                const wordBlock = document.createElement('div');
                wordBlock.className = 'mb-2 p-2 border rounded bg-light';
                wordBlock.innerHTML = `
                    <strong>${word.english}</strong> - ${word.vietnamese}<br>
                    <small><i>${word.ipa || ''} | ${word.type || ''}</i></small>
                `;
                wordList.appendChild(wordBlock);
            });

            // Xóa danh sách cũ nếu có
            const old = container.querySelector('.mt-3');
            if (old) old.remove();
            container.appendChild(wordList);
        })
        .catch(err => {
            console.error("❌ Lỗi lấy từ vựng:", err);
            alert("Không thể tải từ vựng. Kiểm tra Supabase.");
        });
    }
});
</script>
{% endblock %}
